- name: Setup app
  tags: [app]
  block:
    - name: Ensure app exists
      dokku_app:
        app: "{{ app }}"

    - name: Ensure app is configured
      dokku_config:
        app: "{{ app }}"
        config:
          PORT: "5000"
          DOKKU_LETSENCRYPT_EMAIL: florimond.manca@protonmail.com

    - name: Ensure unintended domains are dropped
      dokku_domains:
        app: "{{ app }}"
        domains:
          - www.dokku.me
          - infomaniak.florimond.dev
        state: absent

    - name: Ensure app has expected domains
      dokku_domains:
        app: "{{ app }}"
        domains:
          - florimond.dev
          - www.florimond.dev
          - blog.florimond.dev
          - florimondmanca.com
          - blog.florimondmanca.com

    - name: Clone app repository and deploy app
      dokku_clone:
        app: "{{ app }}"
        repository: "{{ app_repository }}"
        build: true
      async: 200
      poll: 10

    - name: Ensure app has letsencrypt
      dokku_letsencrypt:
        app: "{{ app }}"
    
    - name: Ensure LetsEncrypt auto-renew is enabled in Dokku
      shell: dokku letsencrypt:cron-job --add
      become: true
